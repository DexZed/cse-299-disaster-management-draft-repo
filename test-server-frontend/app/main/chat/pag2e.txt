"use client";
import { ChatCompletion } from "@/app/utilities";
import { useEffect, useState } from "react";
import { io } from "socket.io-client";
import { remark } from "remark";
import html from "remark-html";
import matter from "gray-matter";
type Props = {};
const CHAT_BASE_URL = process.env.NEXT_PUBLIC_CHAT_BASE_URL || 'http://localhost:3001';

function page({}: Props) {
  const [message, setMessage] = useState("");
  const [aiResponse, setAiResponse] = useState<ChatCompletion[]>([]);
  const [render, setRender] = useState<string>("");
  const socket = io(`${CHAT_BASE_URL}/chat`);

  useEffect(() => {
    socket.on("connect", () => console.log("Connected:", socket.id));
    socket.on("onMessage", (data) => {
      // Append chunk to the UI state
      setAiResponse((prev) => prev + data.content);
    });
    socket.on("disconnect", () => console.log("Disconnected"));
    setRender((prev) => prev + generateResponseUi(aiResponse));
    return () => {
      // Clean up the socket when component unmounts
      socket.disconnect();
    };
  }, []);

  async function generateResponseUi(data: string) {
    const matterResult = matter(data);
    const content = await remark().use(html).process(matterResult.content);
    const contentHtml = content.toString();
    return contentHtml;
  }

  async function handleMessage(message: string) {
    socket.emit("generateText", {
      message: [
        {
          role: "user",
          content: message,
        },
      ],
    });
  }
  return (
    <>
      <div className="flex justify-center items-center relative flex-col">
        <div className="flex flex-col" dangerouslySetInnerHTML={{ __html: render }}></div>
        <div className="flex items-center justify-center top-170 absolute w-full ">
          <input
            type="text"
            placeholder="message"
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            onKeyDown={async (event) => {
              if (event.key === "Enter") {
                await handleMessage(message);
              }
            }}
            className="input input-accent input-outline w-full m-20  rounded-full"
          />
        </div>
      </div>
    </>
  );
}

export default page;
